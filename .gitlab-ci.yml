stages:
  - validate
  - plan
  - deploy

.base-terraform:
  tags:
    - docker
  image: 
    name: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  variables:
    TF_ADDRESS: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/aws-buckets

terraform-fmt:
  stage: validate
  extends: .base-terraform
  before_script:
    - cp .terraformrc ~/
  script:
    - terraform fmt -check -recursive

terraform-validate:
  stage: validate
  extends: .base-terraform
  before_script:
    - cp .terraformrc ~/
  script:
    - gitlab-terraform init; gitlab-terraform validate

terraform-plan:
  stage: plan
  extends: .base-terraform
  before_script:
    - cp .terraformrc ~/
  script:
    - gitlab-terraform plan

deploy:
  stage: deploy
  extends: .base-terraform
  before_script:
    - cp .terraformrc ~/
  script:
    - gitlab-terraform apply